<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Zenia IA Chat</title>
  <style>
    :root {
      --primary-color: #007bff; /* Bleu Zenia */
      --primary-hover-color: #0056b3;
      --background-color: #f0f2f5;
      --chat-bubble-ai-bg: #e9e9eb;
      --chat-bubble-user-bg: #007bff;
      --chat-bubble-user-text: #ffffff;
      --text-color: #1c1e21;
      --secondary-text-color: #606770;
      --border-color: #ced0d4;
      --header-height: 110px; /* Ajusté pour deux lignes */
      --input-area-height: 70px;
    }

    html, body {
      height: 100%;
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      overflow: hidden; /* Empêche le scroll du body */
    }

    .app-container {
      display: flex;
      flex-direction: column;
      height: 100vh; /* Pleine hauteur de la vue */
      max-width: 600px; /* Limite la largeur sur desktop pour un look mobile */
      margin: 0 auto;
      background-color: white;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
    }

    .chat-header {
      background-color: #ffffff;
      padding: 15px;
      border-bottom: 1px solid var(--border-color);
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      height: var(--header-height);
      box-sizing: border-box;
      flex-shrink: 0;
    }

    .chat-header h1 {
      font-size: 1.4rem;
      margin: 0 0 10px 0;
      color: var(--primary-color);
      text-align: center;
    }

    .chat-header select {
      width: 100%;
      padding: 10px;
      font-size: 0.9rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background-color: var(--background-color);
      appearance: none; /* Remove default arrow */
      background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20width%3D%2220%22%20height%3D%2220%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cpath%20d%3D%22M5%208l5%205%205-5z%22%20fill%3D%22%23606770%22%2F%3E%3C%2Fsvg%3E');
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 16px;
    }

    #output {
      flex-grow: 1; /* Prend l'espace restant */
      overflow-y: auto;
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 10px; /* Espace entre les bulles */
    }

    .message {
      padding: 10px 15px;
      border-radius: 18px;
      max-width: 75%;
      line-height: 1.4;
      word-wrap: break-word;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .user-message {
      background-color: var(--chat-bubble-user-bg);
      color: var(--chat-bubble-user-text);
      align-self: flex-end;
      border-bottom-right-radius: 4px; /* Style "queue" de bulle */
    }

    .ai-message {
      background-color: var(--chat-bubble-ai-bg);
      color: var(--text-color);
      align-self: flex-start;
      border-bottom-left-radius: 4px; /* Style "queue" de bulle */
    }

    .ai-message strong {
      display: block;
      font-size: 0.8rem;
      margin-bottom: 4px;
      color: var(--primary-color); /* Nom de l'IA en bleu */
    }

    .typing-indicator {
        display: flex;
        align-items: center;
        padding: 8px 12px;
    }
    .typing-indicator span {
        height: 8px;
        width: 8px;
        margin: 0 2px;
        background-color: #aaa;
        border-radius: 50%;
        display: inline-block;
        animation: bounce 1.4s infinite ease-in-out both;
    }
    .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes bounce {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1.0); }
    }


    .input-area {
      display: flex;
      align-items: center;
      padding: 10px 15px;
      border-top: 1px solid var(--border-color);
      background-color: #ffffff;
      height: var(--input-area-height);
      box-sizing: border-box;
      flex-shrink: 0;
    }

    #input {
      flex-grow: 1;
      padding: 12px;
      font-size: 1rem;
      border: 1px solid var(--border-color);
      border-radius: 20px; /* Plus arrondi */
      resize: none; /* Empêche le redimensionnement manuel */
      margin-right: 10px;
      min-height: 24px; /* Hauteur initiale pour une ligne */
      max-height: 100px; /* Limite l'expansion */
      overflow-y: auto; /* Permet le scroll si > max-height */
      line-height: 1.4;
    }

    #send {
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 50%; /* Bouton rond */
      width: 48px;
      height: 48px;
      font-size: 1.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s ease;
      flex-shrink: 0;
    }
    #send:hover {
      background-color: var(--primary-hover-color);
    }
    #send:disabled {
      background-color: #bcc0c4;
      cursor: not-allowed;
    }
    #send svg { /* Style pour l'icône SVG */
        width: 24px;
        height: 24px;
        fill: white;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <header class="chat-header">
      <h1>Zenia IA Chat</h1>
      <select id="collaborator">
        <option value="max">Max – Expert SEO</option>
        <option value="clara">Clara – Stratège Newsletter</option>
        <option value="lucas">Lucas – Pro Onboarding & Lead</option>
        <option value="hugo">Hugo – Analyste de Données</option>
      </select>
    </header>

    <div id="output" aria-live="polite">
      <!-- Les messages du chat apparaîtront ici -->
    </div>

    <div class="input-area">
      <textarea id="input" placeholder="Votre message..." rows="1"></textarea>
      <button id="send" title="Envoyer">
        <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
      </button>
    </div>
  </div>

  <script type="module">
    import { HfInference } from 'https://cdn.skypack.dev/@huggingface/inference';

    const HF_TOKEN = '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'; // Gardez votre token ici
    const client = new HfInference(HF_TOKEN);

    const sendBtn = document.getElementById('send');
    const inputEl = document.getElementById('input');
    const outputEl = document.getElementById('output');
    const collaboratorSelect = document.getElementById('collaborator');

    const collaboratorPrompts = {
      max: {
        name: "Max (SEO)",
        system_prompt: `Vous êtes Max, un collaborateur IA SEO expert pour la plateforme Zenia. Votre rôle est d'analyser le site du client, de fournir des audits SEO complets (structure, vitesse, balises, maillage), d'analyser le contenu et le trafic. Vous extrayez les mots-clés, faites des recommandations hebdomadaires (nouveaux contenus, optimisations, liens) et pouvez générer un contenu SEO optimisé par semaine. Vos rapports SEO incluent évolution du trafic, positions, erreurs techniques et recommandations actionnables. Répondez de manière professionnelle, axée sur les résultats SEO, et claire. Utilisez des listes à puces pour les recommandations si pertinent.`
      },
      clara: {
        name: "Clara (Newsletter)",
        system_prompt: `Vous êtes Clara, une collaboratrice IA spécialisée dans la création de newsletters pour la plateforme Zenia. Vous aidez à configurer le ton de voix, la fréquence et la cible. Vous rédigez des newsletters hebdomadaires basées sur l'actualité de l'entreprise, le comportement des visiteurs, et les contenus SEO de Max. Vous proposez des brouillons pour validation, automatisez l'ajout d'abonnés et adaptez le contenu. Vos rapports incluent statistiques (ouvertures, clics, désinscriptions) et suggestions d'amélioration. Soyez créative, engageante et professionnelle. N'hésitez pas à utiliser des emojis pertinents pour dynamiser vos propositions.`
      },
      lucas: {
        name: "Lucas (Onboarding)",
        system_prompt: `Vous êtes Lucas, un collaborateur IA chargé de l'onboarding des visiteurs et de la qualification des leads pour la plateforme Zenia. Via un chatbot humanisé, vous accueillez les visiteurs, qualifiez leurs besoins, budget et contact, et les redirigez vers des actions clés (RDV, document, formulaire). Vous adaptez le script conversationnel, collectez les données, et enrichissez le scoring des leads. Vos rapports indiquent le nombre et la qualité des leads, avec des suggestions d'optimisation UX. Soyez accueillant, direct, efficace et professionnel. Posez des questions claires pour qualifier.`
      },
      hugo: {
        name: "Hugo (Analytics)",
        system_prompt: `Vous êtes Hugo, un collaborateur IA expert en analytics pour la plateforme Zenia. Vous surveillez les KPIs du site (pages vues, durée, taux de rebond, tunnel de conversion), analysez le comportement des visiteurs et détectez les anomalies. En cas de performance anormale, vous alertez et proposez des recommandations UX (CTA, sections, pages). Vous croisez les données avec celles de Max (SEO) et Clara (Newsletter) pour des suggestions synergiques. Vos rapports clairs incluent KPIs visuels, graphiques si possible (en texte), alertes et recommandations concrètes. Soyez précis, analytique, factuel et orienté action.`
      }
    };

    function scrollToBottom() {
      outputEl.scrollTop = outputEl.scrollHeight;
    }

    function addMessageToChat(text, senderName, isUser = false, isTypingIndicator = false) {
      const messageDiv = document.createElement('div');
      if (isTypingIndicator) {
        messageDiv.classList.add('message', 'ai-message', 'typing-indicator-container'); // Ajout d'une classe conteneur
        messageDiv.innerHTML = `<strong>${senderName} est en train d'écrire...</strong><div class="typing-indicator"><span></span><span></span><span></span></div>`;
      } else {
        messageDiv.classList.add('message');
        if (isUser) {
          messageDiv.classList.add('user-message');
          messageDiv.textContent = text;
        } else {
          messageDiv.classList.add('ai-message');
          const senderStrong = document.createElement('strong');
          senderStrong.textContent = senderName + ':';
          messageDiv.appendChild(senderStrong);
          const contentSpan = document.createElement('span');
          contentSpan.style.whiteSpace = 'pre-wrap'; // Pour conserver les retours à la ligne du LLM
          contentSpan.textContent = text;
          messageDiv.appendChild(contentSpan);
        }
      }
      outputEl.appendChild(messageDiv);
      scrollToBottom();
      return messageDiv;
    }

    // Auto-ajustement de la hauteur du textarea
    inputEl.addEventListener('input', () => {
      inputEl.style.height = 'auto'; // Réinitialise la hauteur
      inputEl.style.height = (inputEl.scrollHeight) + 'px'; // Ajuste à la hauteur du contenu
      // Limiter la hauteur maximale si nécessaire
      if (inputEl.scrollHeight > 100) { // 100px est la max-height CSS
          inputEl.style.overflowY = 'auto';
      } else {
          inputEl.style.overflowY = 'hidden';
      }
    });


    async function handleSend() {
      const userPrompt = inputEl.value.trim();
      if (!userPrompt) return;

      const selectedCollaboratorKey = collaboratorSelect.value;
      const collaboratorInfo = collaboratorPrompts[selectedCollaboratorKey];

      addMessageToChat(userPrompt, "Utilisateur", true);
      inputEl.value = '';
      inputEl.style.height = 'auto'; // Réinitialise la hauteur après envoi
      sendBtn.disabled = true;

      // Ajoute un indicateur de frappe
      const typingMessage = addMessageToChat('', collaboratorInfo.name, false, true);


      try {
        const stream = client.chatCompletionStream({
          model: 'meta-llama/Llama-3.3-70B-Instruct',
          messages: [
            { role: 'system', content: collaboratorInfo.system_prompt },
            { role: 'user', content: userPrompt }
          ],
          temperature: 0.6,
          max_tokens: 1000,
          top_p: 0.9,
        });

        let out = '';
        // On va créer le message de l'IA une fois qu'on a le premier chunk
        let aiMessageDiv = null;
        let aiContentSpan = null;

        for await (const chunk of stream) {
          if (chunk.choices?.length > 0 && chunk.choices[0].delta?.content) {
            // Si c'est le premier chunk, supprimer l'indicateur de frappe et créer le message
            if (!aiMessageDiv) {
              outputEl.removeChild(typingMessage); // Supprime l'indicateur
              aiMessageDiv = addMessageToChat('', collaboratorInfo.name, false); // Crée la bulle de message
              aiContentSpan = aiMessageDiv.querySelector('span'); // Cible le span pour le contenu
            }
            const delta = chunk.choices[0].delta.content;
            out += delta;
            if (aiContentSpan) aiContentSpan.textContent = out;
            scrollToBottom();
          }
        }
        if (!out && aiMessageDiv) { // Si aucun contenu n'a été streamé mais que la bulle existe
            aiContentSpan.textContent = "[L'IA n'a pas fourni de réponse ou une erreur s'est produite pendant le stream]";
        } else if (!out && !aiMessageDiv) { // Aucun stream et l'indicateur de frappe est toujours là
            outputEl.removeChild(typingMessage);
            addMessageToChat("[L'IA n'a pas répondu]", collaboratorInfo.name, false);
        }

      } catch (error) {
        console.error(error);
        if (typingMessage && outputEl.contains(typingMessage)) {
          outputEl.removeChild(typingMessage);
        }
        addMessageToChat('Erreur lors de la requête : ' + error.message, collaboratorInfo.name);
      } finally {
        sendBtn.disabled = false;
      }
    }

    sendBtn.addEventListener('click', handleSend);
    inputEl.addEventListener('keypress', (event) => {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault(); // Empêche le saut de ligne dans le textarea
            handleSend();
        }
    });

    // Message d'accueil initial
    addMessageToChat("Bonjour ! Sélectionnez un collaborateur et posez votre question.", "Système Zenia");

  </script>
</body>
</html>
